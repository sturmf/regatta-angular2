// We try to model with role based access control https://cloud.google.com/firestore/docs/solutions/role-based-access

service cloud.firestore {
  match /databases/{database}/documents {
    match /sailing_clubs/{sailingClub} {

      function isSignedIn() {
        return request.auth != null;
      }

      function getRole() {
        return value(/databases/$(database)/documents/sailing_clubs/$(sailingClub)).roles[request.auth.uid];
      }

      function isOneOfRoles(array) {
        // Determine if the user is one of an array of roles
        return isSignedIn() && (getRole() in array);
      }

      function isValidNewSailingClub() {
        // Valid if story does not exist and the new story has the correct owner.
        return !exists(/databases/$(database)/documents/sailing_clubs/$(sailingClub))
          && request.resource.data.roles[request.auth.uid] == 'owner';
       }

      // Everyone can read the first level
      allow read;

      // Everyone can create a new sailingclub or edit if he is owner
      allow write: if isValidNewSailingClub () || isOneOfRoles(['owner']);

    }
  }
}
